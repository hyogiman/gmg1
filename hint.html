<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒíŠ¸ ì—´ëŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ” íŒíŠ¸ í˜ì´ì§€</h1>

    <div id="loginBox">
      <input type="text" id="teamId" placeholder="íŒ€ ID" />
      <input type="password" id="teamPw" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <button id="loginButton">ë¡œê·¸ì¸</button>
      <p id="loginMsg" style="color: red;"></p>
      <button onclick="resetSession()">[ê°œë°œìš©] ë¡œê·¸ì¸/ìºì‹œ ë¦¬ì…‹</button>
    </div>

    <div id="hintSection" style="display:none;">
      <h2 id="factoryName">ê³µì¥ëª…</h2>
      <img id="hintImage" style="max-width:100%; display:none;" />
      <p id="hintText"></p>
      <p><strong>ë‚¨ì€ ì‹œê°„:</strong> <span id="countdown" style="color:red; font-weight:bold;"></span></p>
    </div>

    <div id="blockMsg" style="display:none; text-align:center; margin-top:40px;">
      <h2 style="color: red;">ğŸš« í˜„ì¬ íŒíŠ¸ ì—´ëŒì´ ì¤‘ì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</h2>
      <button onclick="resetSession()">ğŸ”„ [í…ŒìŠ¤íŠ¸ìš©] ì„¸ì…˜ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>

  <script>
    let currentTeamId = null;
    let countdownInterval;
    let remainingSeconds = 0;

    function resetSession() {
      localStorage.removeItem("hintUser");
      localStorage.removeItem("hintCache");
      location.reload();
    }

    async function login() {
      const id = document.getElementById("teamId").value.trim();
      const pw = document.getElementById("teamPw").value.trim();
      const msg = document.getElementById("loginMsg");

      if (!id || !pw) {
        msg.innerText = "IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }

      try {
        const teamDoc = await db.collection("teams").doc(id).get();
        if (!teamDoc.exists || teamDoc.data().password !== pw) {
          msg.innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì˜ëª»ëœ ì •ë³´ì…ë‹ˆë‹¤.";
          return;
        }

        currentTeamId = id;
        localStorage.setItem("hintUser", id);
        msg.innerText = "";
        document.getElementById("loginBox").style.display = "none";
        showHint();
      } catch (err) {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", err);
        msg.innerText = "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    async function showHint() {
      // ğŸ” ì¤‘ì•™ ì œì–´ ê²€ì‚¬ â†’ config/global.open
      const configDoc = await db.collection("config").doc("global").get();
      if (!configDoc.exists || !configDoc.data().open) {
        localStorage.removeItem("hintCache");
        document.getElementById("hintSection").style.display = "none";
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("blockMsg").style.display = "block";
        return;
      }

      const cached = localStorage.getItem("hintCache");
      let factoryName, hintId, hint;

      if (cached) {
        const cache = JSON.parse(cached);
        factoryName = cache.factoryName;
        hintId = cache.hintId;

        try {
          const hintSnap = await db.collection("hints").doc(factoryName).collection("items").doc(hintId).get();
          if (!hintSnap.exists) throw new Error("íŒíŠ¸ ì—†ìŒ");
          hint = hintSnap.data();
        } catch (err) {
          alert("íŒíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          localStorage.removeItem("hintCache");
          return;
        }
      } else {
        const factoryCode = prompt("ê³µì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (4ìë¦¬):");
        const factories = await db.collection("factories").get();
        factories.forEach(doc => {
          if (doc.data().code === factoryCode) factoryName = doc.id;
        });

        if (!factoryName) {
          alert("ì½”ë“œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        const hintDocs = await db.collection("hints").doc(factoryName).collection("items").get();
        const viewDoc = await db.collection("hint_views").doc(currentTeamId).get();
        const viewed = viewDoc.exists ? (viewDoc.data()[factoryName] || {}) : {};
        const unviewed = hintDocs.docs.filter(doc => !viewed[doc.id]);

        if (unviewed.length === 0) {
          alert("ëª¨ë“  íŒíŠ¸ë¥¼ ì´ë¯¸ ì—´ëŒí–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        const selected = unviewed[Math.floor(Math.random() * unviewed.length)];
        hintId = selected.id;
        hint = selected.data();

        localStorage.setItem("hintCache", JSON.stringify({ factoryName, hintId }));
      }

      const viewDoc = await db.collection("hint_views").doc(currentTeamId).get();
      const viewed = viewDoc.exists ? (viewDoc.data()[factoryName] || {}) : {};
      let startTime;

      if (viewed[hintId]?.startTime) {
        startTime = viewed[hintId].startTime;
      } else {
        startTime = Date.now();
        const update = {
          [`${factoryName}.${hintId}`]: {
            viewed: true,
            startTime
          }
        };
        await db.collection("hint_views").doc(currentTeamId).set(update, { merge: true });
      }

      const timeLimit = hint.timeLimit || 60;
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      remainingSeconds = timeLimit - elapsed;

      if (remainingSeconds <= 0) {
        alert("ì´ íŒíŠ¸ì˜ ì—´ëŒ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      document.getElementById("hintSection").style.display = "block";
      document.getElementById("factoryName").innerText = factoryName + " íŒíŠ¸";
      document.getElementById("hintText").innerText = hint.text || "";

      if (hint.image) {
        const img = document.getElementById("hintImage");
        img.src = hint.image;
        img.style.display = "block";
      }

      startCountdown();
    }

    function startCountdown() {
      const counter = document.getElementById("countdown");
      counter.innerText = `${remainingSeconds}ì´ˆ`;

      countdownInterval = setInterval(() => {
        remainingSeconds--;
        if (remainingSeconds <= 0) {
          clearInterval(countdownInterval);
          document.getElementById("hintSection").style.display = "none";
          alert("ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          counter.innerText = `${remainingSeconds}ì´ˆ`;
        }
      }, 1000);
    }

    window.onload = () => {
      const savedId = localStorage.getItem("hintUser");
      if (savedId) {
        currentTeamId = savedId;
        document.getElementById("loginBox").style.display = "none";
        showHint();
      }

      document.getElementById("loginButton").addEventListener("click", login);
    };
  </script>
</body>
</html>
