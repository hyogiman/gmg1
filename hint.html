<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒíŠ¸ ì—´ëŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ” íŒíŠ¸ í˜ì´ì§€</h1>
    
    <div id="loginBox">
      <input type="text" id="loginTeamId" placeholder="íŒ€ ID" />
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <button onclick="loginTeam()">ë¡œê·¸ì¸</button>
    </div>

    <div id="hintBox" style="display:none;">
      <h2 id="factoryName"></h2>
      <img id="hintImage" style="max-width:100%; display:none;" />
      <p id="hintText"></p>
      <p id="countdown" style="font-weight:bold; color:red;"></p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>

  <script>
    let teamId = null;
    let timerInterval = null;

    async function loginTeam() {
      const id = document.getElementById("loginTeamId").value.trim();
      const pw = document.getElementById("loginPw").value.trim();
      if (!id || !pw) return alert("ID/PWë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

      const teamDoc = await db.collection("teams").doc(id).get();
      if (!teamDoc.exists || teamDoc.data().password !== pw) {
        return alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      teamId = id;
      document.getElementById("loginBox").style.display = "none";
      loadHint();
    }

    async function loadHint() {
      const code = prompt("ê³µì¥ ì½”ë“œ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      const factorySnap = await db.collection("factories").get();
      let factoryName = null;
      factorySnap.forEach(doc => {
        if (doc.data().code === code) {
          factoryName = doc.id;
        }
      });
      if (!factoryName) return alert("ì˜¬ë°”ë¥¸ ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.");

      const hintSnap = await db.collection("hints").doc(factoryName).collection("items").get();
      const viewedDoc = await db.collection("hint_views").doc(teamId).get();
      const viewed = viewedDoc.exists ? viewedDoc.data()?.[factoryName] || {} : {};

      const now = Date.now();
      const available = hintSnap.docs.filter(doc => !viewed[doc.id]);

      if (available.length === 0) {
        document.getElementById("hintBox").style.display = "block";
        document.getElementById("hintText").innerText = "ëª¨ë“  íŒíŠ¸ë¥¼ ì´ë¯¸ í™•ì¸í–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      const randomHint = available[Math.floor(Math.random() * available.length)];
      const hintData = randomHint.data();
      const hintId = randomHint.id;
      <button onclick="loginTeam()">ë¡œê·¸ì¸</button>
      <div id="loginMsg" style="color:red;"></div>
    </div>

    <div id="hintSection" style="display:none;">
      <h2 id="factoryName">ê³µì¥ëª…</h2>
      <p><strong>ë‚¨ì€ ì‹œê°„:</strong> <span id="countdown"></span></p>
      <img id="hintImage" style="max-width:100%; display:none;" />
      <p id="hintText"></p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>
  <script>
    const db = firebase.firestore();
    let timerInterval;
    let remaining = 0;

    async function loginTeam() {
      const id = document.getElementById("teamId").value.trim();
      const pw = document.getElementById("teamPw").value.trim();
      const msg = document.getElementById("loginMsg");

      const doc = await db.collection("teams").doc(id).get();
      if (!doc.exists || doc.data().password !== pw) {
        msg.innerText = "ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
        return;
      }

      localStorage.setItem("teamId", id);
      showHint();
    }

    async function showHint() {
      const teamId = localStorage.getItem("teamId");
      if (!teamId) return;

      document.getElementById("loginSection").style.display = "none";

      const factoryCode = prompt("ê³µì¥ ì½”ë“œ ì…ë ¥:");
      const factories = await db.collection("factories").get();
      let matchedFactory = null;

      factories.forEach(doc => {
        if (doc.data().code === factoryCode) {
          matchedFactory = doc.id;
        }
      });

      if (!matchedFactory) {
        alert("ì˜ëª»ëœ ê³µì¥ ì½”ë“œì…ë‹ˆë‹¤.");
        return;
      }

      const hintSnap = await db.collection("hints").doc(matchedFactory).collection("items").get();
      const viewsRef = db.collection("hint_views").doc(teamId);
      const viewsDoc = await viewsRef.get();
      const viewed = viewsDoc.exists ? (viewsDoc.data()[matchedFactory] || {}) : {};

      const unviewed = hintSnap.docs.filter(doc => !viewed[doc.id]);
      if (unviewed.length === 0) {
        alert("ëª¨ë“  íŒíŠ¸ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const randomHint = unviewed[Math.floor(Math.random() * unviewed.length)];
      const hint = randomHint.data();
      const hintId = randomHint.id;

      // ê¸°ë¡ ì‹œê°„
      const now = Date.now();
      const startTime = viewed[hintId]?.startTime || now;
      const timeLimit = hint.timeLimit || 60;
      const elapsed = Math.floor((now - startTime) / 1000);
      remaining = timeLimit - elapsed;

      if (remaining <= 0) {
        alert("ì´ íŒíŠ¸ì˜ ì—´ëŒ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const update = {
        [`${matchedFactory}.${hintId}`]: {
          viewed: true,
          startTime
        }
      };
      await viewsRef.set(update, { merge: true });

      document.getElementById("hintSection").style.display = "block";
      document.getElementById("factoryName").innerText = `${matchedFactory} íŒíŠ¸`;
      document.getElementById("hintText").innerText = hint.text || "";
      if (hint.image) {
        document.getElementById("hintImage").src = hint.image;
        document.getElementById("hintImage").style.display = "block";
      }

      startTimer();
    }

    function startTimer() {
      document.getElementById("countdown").innerText = `${remaining}ì´ˆ`;
      timerInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          document.getElementById("hintSection").style.display = "none";
          alert("ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          document.getElementById("countdown").innerText = `${remaining}ì´ˆ`;
        }
      }, 1000);
    }

    // ìë™ ë¡œê·¸ì¸ ë³µì›
    window.onload = () => {
      const teamId = localStorage.getItem("teamId");
      if (teamId) showHint();
    };
  </script>
</body>
</html>
