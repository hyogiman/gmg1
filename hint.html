<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒíŠ¸ í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ” íŒíŠ¸ í˜ì´ì§€</h1>
    <div id="statusMessage">í”„ë¡œê·¸ë¨ ìƒíƒœ í™•ì¸ ì¤‘...</div>

    <div id="codeInputBox" style="margin-top: 20px;">
      <input type="text" id="factoryCodeInput" placeholder="ê³µì¥ ì½”ë“œ ì…ë ¥ (4ìë¦¬)" maxlength="4" />
      <button onclick="loadHint()">íŒíŠ¸ ë³´ê¸°</button>
    </div>

    <div id="hintContent" style="display:none; margin-top: 20px;">
      <h2 id="factoryName">ê³µì¥ëª…</h2>
      <img id="hintImage" src="" alt="íŒíŠ¸ ì´ë¯¸ì§€" style="max-width:100%; border-radius:8px; margin-bottom:10px;" />
      <p id="hintText"></p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>
  <script>
    let factories = {};

    async function checkProgramStatus() {
      const doc = await db.collection("config").doc("global").get();
      const open = doc.exists && doc.data().open === true;
      const status = document.getElementById("statusMessage");
      if (!open) {
        status.innerText = "ì•„ì§ í”„ë¡œê·¸ë¨ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        document.getElementById("codeInputBox").style.display = "none";
      } else {
        status.innerText = "ê³µì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì—¬ íŒíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        loadFactories();
      }
    }

    async function loadFactories() {
      const snap = await db.collection("factories").get();
      snap.forEach(doc => {
        factories[doc.data().code] = { name: doc.id };
      });
    }

    async function loadHint() {
      const code = document.getElementById("factoryCodeInput").value.trim();
      const hintDiv = document.getElementById("hintContent");
      const nameTag = document.getElementById("factoryName");
      const imgTag = document.getElementById("hintImage");
      const textTag = document.getElementById("hintText");

      if (!factories[code]) {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œì…ë‹ˆë‹¤.");
        return;
      }

      const factoryName = factories[code].name;
      nameTag.innerText = `${factoryName} íŒíŠ¸`;

      const doc = await db.collection("hints").doc(factoryName).get();
      if (!doc.exists) {
        hintDiv.style.display = "block";
        imgTag.style.display = "none";
        textTag.innerText = "ë“±ë¡ëœ íŒíŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const hint = doc.data();
      textTag.innerText = hint.text || "íŒíŠ¸ í…ìŠ¤íŠ¸ ì—†ìŒ";
      if (hint.image) {
        imgTag.src = hint.image;
        imgTag.style.display = "block";
      } else {
        imgTag.style.display = "none";
      }

      hintDiv.style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", checkProgramStatus);
  </script>
</body>
</html>
