<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>힌트 페이지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>🔍 힌트 페이지</h1>
    <div id="statusMessage">프로그램 상태 확인 중...</div>

    <div id="codeInputBox" style="margin-top: 20px;">
      <input type="text" id="factoryCodeInput" placeholder="공장 코드 입력 (4자리)" maxlength="4" />
      <button onclick="loadHint()">힌트 보기</button>
    </div>

    <div id="hintContent" style="display:none; margin-top: 20px;">
      <h2 id="factoryName">공장명</h2>
      <img id="hintImage" src="" alt="힌트 이미지" style="max-width:100%; border-radius:8px; margin-bottom:10px;" />
      <p id="hintText"></p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>
  <script>
    let factories = {};

    async function checkProgramStatus() {
      const doc = await db.collection("config").doc("global").get();
      const open = doc.exists && doc.data().open === true;
      const status = document.getElementById("statusMessage");
      if (!open) {
        status.innerText = "아직 프로그램이 시작되지 않았습니다.";
        document.getElementById("codeInputBox").style.display = "none";
      } else {
        status.innerText = "공장 코드를 입력하여 힌트를 확인하세요.";
        loadFactories();
      }
    }

    async function loadFactories() {
      const snap = await db.collection("factories").get();
      snap.forEach(doc => {
        factories[doc.data().code] = { name: doc.id };
      });
    }

    async function loadHint() {
      const code = document.getElementById("factoryCodeInput").value.trim();
      const hintDiv = document.getElementById("hintContent");
      const nameTag = document.getElementById("factoryName");
      const imgTag = document.getElementById("hintImage");
      const textTag = document.getElementById("hintText");

      if (!factories[code]) {
        alert("유효하지 않은 코드입니다.");
        return;
      }

      const factoryName = factories[code].name;
      nameTag.innerText = `${factoryName} 힌트`;

      const doc = await db.collection("hints").doc(factoryName).get();
      if (!doc.exists) {
        hintDiv.style.display = "block";
        imgTag.style.display = "none";
        textTag.innerText = "등록된 힌트 정보가 없습니다.";
        return;
      }

      const hint = doc.data();
      textTag.innerText = hint.text || "힌트 텍스트 없음";
      if (hint.image) {
        imgTag.src = hint.image;
        imgTag.style.display = "block";
      } else {
        imgTag.style.display = "none";
      }

      hintDiv.style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", checkProgramStatus);
  </script>
</body>
</html>
