<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hint2 - íŒíŠ¸ ì½”ë“œ ì…ë ¥</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <style>
    .hint-box {
      border: 1px solid #ccc;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
    }
    .timer {
      font-size: 24px;
      margin-top: 10px;
      color: red;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” íŒíŠ¸ ì½”ë“œ ì…ë ¥</h1>

    <!-- ğŸ” ë¡œê·¸ì¸ -->
    <div id="login-section">
      <input type="text" id="teamId" placeholder="íŒ€ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <input type="password" id="teamPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button onclick="login()">ë¡œê·¸ì¸</button>
    </div>

    <!-- ğŸ”‘ íŒíŠ¸ ì½”ë“œ ì…ë ¥ -->
    <div id="input-section" style="display: none;">
      <input type="text" id="hintCodeInput" placeholder="íŒíŠ¸ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
      <button onclick="submitCode()">í™•ì¸</button>
    </div>

    <!-- ğŸ“„ íŒíŠ¸ ì¶œë ¥ -->
    <div id="hint-section" class="hint-box" style="display: none;">
      <div id="hintText"></div>
      <img id="hintImage" src="" alt="" style="max-width: 100%; display: none;" />
      <div id="hintTimer" class="timer"></div>
    </div>
  </div>

  <!-- Firebase SDK (Module ë°©ì‹) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCxRR6hXvk9Z17eK8H_Vov_TbGX8LzvDs",
      authDomain: "factory-sim01v.firebaseapp.com",
      projectId: "factory-sim01v",
      storageBucket: "factory-sim01v.firebasestorage.app",
      messagingSenderId: "818674298880",
      appId: "1:818674298880:web:95307171220da8bd8d28e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentTeamId = null;

    // âœ… ë¡œê·¸ì¸ ì²˜ë¦¬
    async function login() {
      const teamInput = document.getElementById("teamId").value.trim();
      const pwInput = document.getElementById("teamPw").value.trim();

      if (!teamInput || !pwInput) {
        alert("íŒ€ IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const teamRef = doc(db, `teams/${teamInput}`);
      const teamSnap = await getDoc(teamRef);

      if (!teamSnap.exists()) {
        alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŒ€ IDì…ë‹ˆë‹¤.");
        return;
      }

      const teamData = teamSnap.data();
      if (teamData.password !== pwInput) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      currentTeamId = teamInput;
      document.getElementById("login-section").style.display = "none";
      document.getElementById("input-section").style.display = "block";
    }

    // âœ… íŒíŠ¸ ì½”ë“œ ì œì¶œ
    async function submitCode() {
      const code = document.getElementById("hintCodeInput").value.trim().toUpperCase();
      if (!code) return alert("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

      const viewRef = doc(db, `code_hint_views/${currentTeamId}`);
      const viewSnap = await getDoc(viewRef);
      const views = viewSnap.exists() ? viewSnap.data() : {};

      if (views[code]?.viewed) {
        return alert("ì´ë¯¸ ë³¸ íŒíŠ¸ì…ë‹ˆë‹¤.");
      }

      const hintRef = doc(db, `codeHints/${code}`);
      const hintSnap = await getDoc(hintRef);

      if (!hintSnap.exists()) {
        return alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì½”ë“œì…ë‹ˆë‹¤.");
      }

      const hint = hintSnap.data();
      document.getElementById("hintText").innerText = hint.text || "";
      if (hint.imageUrl) {
        const img = document.getElementById("hintImage");
        img.src = hint.imageUrl;
        img.style.display = "block";
      }

      document.getElementById("hint-section").style.display = "block";

      // ì—´ëŒ ê¸°ë¡ ì €ì¥
      const record = {
        [code]: {
          viewed: true,
          startTime: serverTimestamp()
        }
      };

      if (viewSnap.exists()) {
        await updateDoc(viewRef, record);
      } else {
        await setDoc(viewRef, record);
      }

      // ì „ì—­ ì„¤ì • íƒ€ì´ë¨¸ í™•ì¸
      const configRef = doc(db, "config/hintTimer");
      const configSnap = await getDoc(configRef);
      const hintTimerEnabled = configSnap.exists() && configSnap.data().enabled;

      if (hintTimerEnabled) {
        let duration = parseInt(hint.duration) || 30;
        const timerDiv = document.getElementById("hintTimer");
        timerDiv.innerText = `${duration}ì´ˆ ë‚¨ìŒ`;

        const countdown = setInterval(() => {
          duration--;
          if (duration <= 0) {
            clearInterval(countdown);
            alert("íŒíŠ¸ ë…¸ì¶œì´ ëë‚¬ìŠµë‹ˆë‹¤.");
            resetView();
          } else {
            timerDiv.innerText = `${duration}ì´ˆ ë‚¨ìŒ`;
          }
        }, 1000);
      }
    }

    // âœ… íŒíŠ¸ ì¢…ë£Œ ì²˜ë¦¬
    function resetView() {
      document.getElementById("hintText").innerText = "";
      document.getElementById("hintImage").style.display = "none";
      document.getElementById("hintImage").src = "";
      document.getElementById("hint-section").style.display = "none";
      document.getElementById("hintTimer").innerText = "";
      document.getElementById("hintCodeInput").value = "";
    }
  </script>
</body>
</html>
