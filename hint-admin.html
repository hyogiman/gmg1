<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒíŠ¸ ê´€ë¦¬ì (ë‹¤ì¤‘ ê´€ë¦¬)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ› ï¸ íŒíŠ¸ ê´€ë¦¬ì (ë‹¤ì¤‘ íŒíŠ¸ ê´€ë¦¬)</h1>

    <label>ê³µì¥ ì„ íƒ:</label>
    <select id="factorySelector" onchange="loadHintList()"></select>

    <hr>

    <h2>ğŸ“‹ ë“±ë¡ëœ íŒíŠ¸ ëª©ë¡</h2>
    <ul id="hintList"></ul>

    <hr>

    <h2 id="editTitle">â• ìƒˆ íŒíŠ¸ ë“±ë¡</h2>
    <label>íŒíŠ¸ í…ìŠ¤íŠ¸:</label>
    <textarea id="hintText" rows="4" placeholder="íŒíŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

    <label>íŒíŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ:</label>
    <input type="file" id="hintImage" accept="image/*" />
    <img id="previewImage" style="max-width: 200px; display:none; margin-top:10px;" />

    <button onclick="saveHint()">ì €ì¥</button>
    <button onclick="resetForm()" style="background:#ccc; color:#000;">ì´ˆê¸°í™”</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-init.js"></script>
  <script>
    let factories = [];
    let currentFactory = null;
    let editingHintId = null;

    async function loadFactories() {
      const snap = await db.collection("factories").get();
      const selector = document.getElementById("factorySelector");
      selector.innerHTML = "<option value=''>-- ê³µì¥ ì„ íƒ --</option>";
      snap.forEach(doc => {
        factories.push(doc.id);
        selector.innerHTML += `<option value="${doc.id}">${doc.id}</option>`;
      });
    }

    async function loadHintList() {
      currentFactory = document.getElementById("factorySelector").value;
      const list = document.getElementById("hintList");
      list.innerHTML = "";

      if (!currentFactory) return;

      const snap = await db.collection("hints").doc(currentFactory).collection("items").get();
      snap.forEach(doc => {
        const hint = doc.data();
        list.innerHTML += `
          <li>
            <b>${hint.text?.slice(0, 30) || '[í…ìŠ¤íŠ¸ ì—†ìŒ]'}</b>
            <button onclick="editHint('${doc.id}')">ìˆ˜ì •</button>
            <button onclick="deleteHint('${doc.id}')">ì‚­ì œ</button>
          </li>`;
      });
    }

    async function editHint(id) {
      editingHintId = id;
      document.getElementById("editTitle").innerText = "âœï¸ íŒíŠ¸ ìˆ˜ì •";
      const doc = await db.collection("hints").doc(currentFactory).collection("items").doc(id).get();
      const data = doc.data();
      document.getElementById("hintText").value = data.text || "";
      if (data.image) {
        document.getElementById("previewImage").src = data.image;
        document.getElementById("previewImage").style.display = "block";
      }
    }
    async function deleteHint(id) {
      const confirmDelete = confirm("í•´ë‹¹ íŒíŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (confirmDelete) {
        await db.collection("hints").doc(currentFactory).collection("items").doc(id).delete();
        loadHintList();
        resetForm();
      }
    }

    async function saveHint() {
      if (!currentFactory) return alert("ê³µì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      const text = document.getElementById("hintText").value.trim();
      const file = document.getElementById("hintImage").files[0];
      let imageData = null;

      if (file) {
        imageData = await toBase64(file);
      } else {
        const current = document.getElementById("previewImage").src;
        if (current && current.startsWith("data:")) {
          imageData = current;
        }
      }

      const hintData = { text, image: imageData };

      const collectionRef = db.collection("hints").doc(currentFactory).collection("items");
      if (editingHintId) {
        await collectionRef.doc(editingHintId).set(hintData);
        alert("íŒíŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        await collectionRef.add(hintData);
        alert("íŒíŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      loadHintList();
      resetForm();
    }

    function resetForm() {
      editingHintId = null;
      document.getElementById("editTitle").innerText = "â• ìƒˆ íŒíŠ¸ ë“±ë¡";
      document.getElementById("hintText").value = "";
      document.getElementById("hintImage").value = "";
      document.getElementById("previewImage").style.display = "none";
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    document.getElementById("hintImage").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        document.getElementById("previewImage").src = evt.target.result;
        document.getElementById("previewImage").style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    document.addEventListener("DOMContentLoaded", loadFactories);
  </script>
</body>
</html>
